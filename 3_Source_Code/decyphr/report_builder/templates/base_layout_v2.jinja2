<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decyphr</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Loading Outfit to match Google Sans aesthetic -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

    <style>
        {{ embedded_css | safe }}
    </style>
</head>

<body>

    <header class="app-header">
        <div class="logo-text">
            Decyphr
        </div>

        <div class="nav-scroll-wrapper">
            <nav class="top-nav" id="top-nav-scroll">
                <ul>
                    <!-- Fixed Executive Summary Link -->
                    {% if executive_summary_html %}
                    <li><a href="#" data-section-id="executive_summary" class="nav-link active">Executive Summary</a>
                    </li>
                    {% endif %}

                    <!-- Prioritized Links -->
                    {% for section_id, section_title in sections %}
                    {% if section_id == 'p17_business_insights' %}
                    <li><a href="#" data-section-id="{{ section_id }}" class="nav-link">{{ section_title }}</a></li>
                    {% endif %}
                    {% endfor %}

                    {% for section_id, section_title in sections %}
                    {% if section_id == 'p18_decision_engine' %}
                    <li><a href="#" data-section-id="{{ section_id }}" class="nav-link">{{ section_title }}</a></li>
                    {% endif %}
                    {% endfor %}

                    {% if system_metrics %}
                    <li><a href="#" data-section-id="system_metrics" class="nav-link">System Performance</a></li>
                    {% endif %}

                    <!-- Remaining Links -->
                    {% for section_id, section_title in sections %}
                    {% if section_id not in ['p17_business_insights', 'p18_decision_engine', 'p01_overview'] %}
                    <li><a href="#" data-section-id="{{ section_id }}" class="nav-link">{{ section_title }}</a></li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </nav>
            <button class="nav-scroll-btn" id="nav-scroll-right" aria-label="Scroll Right">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.59 16.59L13.17 12L8.59 7.41L10 6L16 12L10 18L8.59 16.59Z" fill="currentColor" />
                </svg>
            </button>
        </div>

        <div class="header-right">
            <!-- Space for future actions -->
        </div>
    </header>

    <main class="main-content">
        <div class="report-header">
            <h2>Experience liftoff<br><span class="header-subtitle">with your data.</span>
            </h2>
            <p>Analysis for <strong>{{ dataset_name }}</strong> successfully generated.</p>
        </div>

        <!-- Executive Summary Injection -->
        {% if executive_summary_html %}
        {{ executive_summary_html | safe }}
        {% endif %}

        <!-- 1. Business Insights (Prioritized) -->
        {% if 'p17_business_insights' in sections_data %}
        {% set section_content = sections_data['p17_business_insights'] %}
        <div class="content-panel active" id="panel-p17_business_insights">
            <h3 class="section-title">{{ section_content.title }}</h3>
            <div class="details-container">{{ section_content.details_html | safe }}</div>
        </div>
        {% endif %}

        <!-- 2. Decision Engine (Prioritized) -->
        {% if 'p18_decision_engine' in sections_data %}
        {% set section_content = sections_data['p18_decision_engine'] %}
        <div class="content-panel active" id="panel-p18_decision_engine">
            <h3 class="section-title">{{ section_content.title }}</h3>
            <div class="details-container">{{ section_content.details_html | safe }}</div>
        </div>
        {% endif %}

        <!-- 3. System Performance Summary (NEW SECTION) -->
        {% if system_metrics %}
        <div class="content-panel system-dashboard" id="panel-system_metrics">
            <h3 class="section-title">System Performance Summary</h3>

            <div class="dashboard-grid">

                <!-- System Metrics Card -->
                <div class="card-kpi">
                    <h4 class="kpi-label">System Metrics</h4>
                    <div class="metrics-grid">
                        <div>
                            <div class="kpi-label">Execution Time</div>
                            <div class="kpi-number">{{ system_metrics.runtime_execution_time }}s</div>
                        </div>
                        <div>
                            <div class="kpi-label">Anomalies Detected</div>
                            <div class="kpi-number">{{ system_metrics.anomaly_count }}</div>
                        </div>
                        <div>
                            <div class="kpi-label">Insights Generated</div>
                            <div class="kpi-number">{{ system_metrics.number_of_insights_generated }}</div>
                        </div>
                        <div>
                            <div class="kpi-label">Recommendations</div>
                            <div class="kpi-number">{{ system_metrics.number_of_recommendations_generated }}</div>
                        </div>
                    </div>
                </div>

                <!-- Dataset Health Card -->
                <div class="card-kpi">
                    <h4 class="kpi-label">Dataset Health</h4>
                    <div class="metrics-grid">
                        <div>
                            <div class="kpi-label">Health Score</div>
                            <div
                                class="kpi-number {% if system_metrics.dataset_statistics.get('Health Score', 0) >= 90 %}text-success{% elif system_metrics.dataset_statistics.get('Health Score', 0) >= 70 %}text-warning{% else %}text-error{% endif %}">
                                {{ system_metrics.dataset_statistics.get('Health Score', 'N/A') }}
                            </div>
                        </div>
                        <div>
                            <div class="kpi-label">Memory Usage</div>
                            <div class="kpi-number">{{ system_metrics.dataset_statistics.get('Memory Usage (MB)', 0) }}
                                MB</div>
                        </div>
                        <div>
                            <div class="kpi-label">Missing Values</div>
                            <div class="kpi-number">{{ system_metrics.dataset_statistics.get('Missing Cells (%)', '0%')
                                }}</div>
                        </div>
                        <div>
                            <div class="kpi-label">Duplicate Rows</div>
                            <div class="kpi-number">{{ system_metrics.dataset_statistics.get('Duplicate Rows (%)', '0%')
                                }}</div>
                        </div>
                    </div>
                </div>

                <!-- Feature Importance Card -->
                <div class="card-kpi">
                    <h4 class="kpi-label">Key Driver</h4>
                    <div>
                        <div class="kpi-label">Top Feature Importance</div>
                        <div class="kpi-number kpi-number-small-wrap">{{
                            system_metrics.top_feature_importance }}</div>
                        <div class="kpi-subtext">Identified as the primary driver of variance in the dataset.</div>
                    </div>
                    <div class="margin-top-24">
                        <div class="kpi-label">Dataset Dimensions</div>
                        <div class="kpi-number kpi-number-small">
                            {% set rows = system_metrics.dataset_statistics.get('Number of Rows', 0) %}
                            {% set cols = system_metrics.dataset_statistics.get('Number of Columns', 0) %}
                            {{ "{:,}".format(rows) }} x {{ cols }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 4. Detailed Statistical Analysis (The Rest) -->
        {% for section_id, section_content in sections_data.items() %}
        <!-- Skip sections we've already rendered or don't want in the detailed list -->
        {% if section_id not in ['p17_business_insights', 'p18_decision_engine', 'p01_overview'] %}
        <div class="content-panel" id="panel-{{ section_id }}">
            <h3 class="section-title">{{ section_content.title }}</h3>

            {% if section_content.details_html %}
            <div class="details-container">
                {{ section_content.details_html | safe }}
            </div>
            {% endif %}

            {% if section_content.visuals_count > 0 %}
            <div class="content-grid">
                {% for i in range(section_content.visuals_count) %}
                <div class="analysis-card">
                    <div class="plot-placeholder" id="plot-{{ section_id }}-{{ i }}"></div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </main>

    <footer class="app-footer footer-centered">
        <p>Decyphr v{{ decyphr_version }} &middot; MSDSM Capstone project By Ayush, Siddharth, Saif, Ujjawal</p>
    </footer>

    <script id="plot-data" type="application/json">
        {{ all_plots_data_json | safe }}
    </script>

    <script>
        {{ embedded_js | safe }}
    </script>
</body>

</html>
